From e23314bc9ef1780fd548f5c3bb611296493e6585 Mon Sep 17 00:00:00 2001
From: msyzdj-web <msyzdj-web@example.com>
Date: Sat, 3 Jan 2026 18:07:10 +0800
Subject: [PATCH] fix: improve receipt printing centering, margins, and
 typography

---
 utils/printer.py | 38 +++++++++++++++++++++++++++-----------
 1 file changed, 27 insertions(+), 11 deletions(-)

diff --git a/utils/printer.py b/utils/printer.py
index d69b40c..70ae38a 100644
--- a/utils/printer.py
+++ b/utils/printer.py
@@ -311,8 +311,8 @@ class ReceiptPrinter:
                     except Exception:
                         right_safe_px = int(self.safe_margin_mm / mm_per_inch * dpi)
 
-                    # 额外给打印驱动留一点安全缓冲（页面宽度的2%或最少20px）
-                    driver_pad = max(int(page_rect.width() * 0.02), 20)
+                    # 给打印驱动留点缓冲，但不要过大（2% 或至少 10px，限制最大 40px）
+                    driver_pad = int(min(max(int(page_rect.width() * 0.02), 10), 40))
 
                     # 计算页面上可用的最大图像宽度（像素）
                     max_available_width = max(0, page_rect.width() - left_safe_px - right_safe_px - driver_pad)
@@ -326,9 +326,24 @@ class ReceiptPrinter:
 
                     target_size = image.size().scaled(QSize(use_w_px, desired_h_px), Qt.KeepAspectRatio)
 
-                    # 计算水平位置：优先保证 left_safe_px，再尽量居中
+                    # 计算水平位置：以页面居中为首选，仅在越界时应用安全边距与驱动缓冲
                     centered_x = int(page_rect.x() + (page_rect.width() - target_size.width()) // 2)
-                    x = max(int(page_rect.x() + left_safe_px), centered_x)
+                    # 允许的最小/最大 x（基于安全边距和驱动缓冲）
+                    min_allowed_x = int(page_rect.x() + left_safe_px)
+                    max_allowed_x = int(page_rect.x() + page_rect.width() - target_size.width() - right_safe_px - driver_pad)
+                    # 如果计算出来的 max < min，则尝试放宽 driver_pad，再退回到页左边界作为兜底
+                    if max_allowed_x < min_allowed_x:
+                        relaxed_pad = max(0, driver_pad - 10)
+                        max_allowed_x = int(page_rect.x() + page_rect.width() - target_size.width() - right_safe_px - relaxed_pad)
+                        if max_allowed_x < min_allowed_x:
+                            min_allowed_x = int(page_rect.x())
+                            max_allowed_x = int(page_rect.x() + page_rect.width() - target_size.width())
+                    # 以居中为首选，然后裁剪到允许范围内
+                    x = centered_x
+                    if x < min_allowed_x:
+                        x = min_allowed_x
+                    if x > max_allowed_x:
+                        x = max_allowed_x
 
                     # 将 top offset 作为向上微调（在 render 时已应用，但在物理页上仍允许少量偏移）
                     try:
@@ -416,10 +431,10 @@ class ReceiptPrinter:
                 margin_scale = 0.02
                 line_spacing_scale = 0.04
             elif is_wide_paper:
-                # 针式打印纸(241x93mm): 宽而扁，高度受限，必须大幅减小基于宽度的字号比例
-                base_font_scale = 0.013  # 1.3% width
+                # 针式打印纸(241x93mm): 宽而扁，高度受限，但为了可读性适度增大字号与行高
+                base_font_scale = 0.016  # 从 1.3% 提升到 1.6% 宽度以放大字体
                 margin_scale = 0.02
-                line_spacing_scale = 0.02
+                line_spacing_scale = 0.025
             else:
                 # A4
                 base_font_scale = 0.018  # 1.8% width
@@ -476,8 +491,8 @@ class ReceiptPrinter:
             
             # 行高计算
             if is_wide_paper:
-                # 241x93高度极小，使用极紧凑行高
-                row_height = int(base_pixel_size * 1.5)
+                # 241x93 高度受限，但为了保证安全距离与可读性，适度提高行高
+                row_height = int(base_pixel_size * 1.9)
             else:
                 row_height = int(base_pixel_size * 2.2)  # 行高为字号的 2.2 倍
             
@@ -1070,10 +1085,11 @@ class ReceiptPrinter:
             # 布局策略：基于宽度计算 PixelSize
             # 布局策略：基于宽度计算 PixelSize
             if is_wide_paper:
-                base_font_scale = 0.013  # 宽纸需较小比例，避免字体过大
+                # 宽纸适度放大基准字号并增加行高因子以提高可读性与安全边距
+                base_font_scale = 0.016
                 margin_scale = 0.02
                 table_width_pct = 0.98
-                row_height_factor = 1.5
+                row_height_factor = 1.9
             elif is_narrow_paper:
                 base_font_scale = 0.035
                 margin_scale = 0.02
-- 
2.39.5 (Apple Git-154)


# 数据库升级说明

## 重要提示

由于本次更新添加了新的数据库字段，需要升级数据库结构。

## 升级方法

### 方法一：重新创建数据库（推荐，适用于开发/测试环境）

1. **备份现有数据**（如果有重要数据）
   - 复制 `property.db` 文件到安全位置

2. **删除旧数据库**
   - 删除 `property.db` 文件

3. **重新运行程序**
   - 程序会自动创建新的数据库结构

### 方法二：手动升级数据库（适用于生产环境）

如果数据库中有重要数据，可以使用SQLite工具手动升级：

```sql
-- 1. 为charge_items表添加unit字段
ALTER TABLE charge_items ADD COLUMN unit VARCHAR(20) DEFAULT '元/月';

-- 2. 为residents表添加move_in_date字段
ALTER TABLE residents ADD COLUMN move_in_date DATETIME;

-- 3. 为payments表添加新字段
ALTER TABLE payments ADD COLUMN billing_start_date DATETIME;
ALTER TABLE payments ADD COLUMN billing_end_date DATETIME;
ALTER TABLE payments ADD COLUMN billing_months INTEGER DEFAULT 1;
ALTER TABLE payments ADD COLUMN paid_months INTEGER DEFAULT 0;
ALTER TABLE payments ADD COLUMN paid_amount NUMERIC(10, 2) DEFAULT 0;

-- 4. 更新现有数据（可选）
-- 为现有记录设置默认值
UPDATE charge_items SET unit = '元/月' WHERE unit IS NULL;
UPDATE payments SET billing_months = 1 WHERE billing_months IS NULL;
UPDATE payments SET paid_months = 0 WHERE paid_months IS NULL;
UPDATE payments SET paid_amount = 0 WHERE paid_amount IS NULL;

-- 注意：billing_start_date和billing_end_date需要根据period字段计算
-- 建议手动设置或重新生成账单
```

## 新增功能说明

### 1. 计费周期功能
- 每个账单现在有独立的计费开始日期和结束日期
- 支持不同业主的不同计费周期
- 自动计算计费月数

### 2. 部分缴费功能
- 支持业主只缴纳部分月份的欠费
- 例如：欠费12个月，可以只缴1个月、3个月、半年等
- 系统会自动计算部分缴费金额

### 3. 收费项目单位
- 每个收费项目现在有单位字段
- 支持：元/月、元/年、元/平方米、元/平方米·月等
- 在生成账单时，金额会根据周期数自动计算

### 4. 入住日期
- 住户信息中新增入住日期字段
- 生成账单时，如果住户有入住日期，会自动设置为计费开始日期

## 使用说明

### 生成账单
1. 选择住户（如果住户有入住日期，会自动设置计费开始日期）
2. 选择收费项目
3. 设置计费开始日期和结束日期（系统自动计算月数）
4. 系统根据周期数自动计算金额
5. 生成账单

### 缴费
1. 选择要缴费的账单
2. 点击"缴费"按钮
3. 在缴费对话框中：
   - 查看账单信息（总月数、已缴月数、剩余月数）
   - 选择要缴费的月数（1-N个月）
   - 系统自动计算缴费金额
4. 确认缴费

### 查看账单
- 账单列表现在显示：
  - 计费周期（开始日期至结束日期）
  - 总月数
  - 已缴月数
  - 缴费状态（已缴费/部分缴费/未缴费）

## 注意事项

1. **数据迁移**：如果使用现有数据库，建议先备份
2. **计费周期**：确保计费开始日期不早于住户入住日期
3. **部分缴费**：缴费月数不能超过剩余未缴费月数
4. **金额计算**：固定和按面积类型的收费项目会根据周期数自动计算


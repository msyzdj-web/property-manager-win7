name: Build Windows 7 Compatible EXE (one-dir)

on:
  workflow_dispatch:
  push:
    branches:
      - main
      - master
      - ci/onedir-artifact

jobs:
  build-win7:
    name: Build (Windows, Python 3.8.10, PyInstaller 4.10) -> onedir (PropertyManager-win7.spec)
    runs-on: windows-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Python 3.8.10
        uses: actions/setup-python@v4
        with:
          python-version: '3.8.10'
          architecture: 'x64'

      - name: Upgrade pip and install dependencies
        run: |
          python -m pip install --upgrade pip
          if (Test-Path requirements-win7.txt) { pip install -r requirements-win7.txt } else { pip install -r requirements.txt }
          pip install pyinstaller==4.10

      - name: Clean previous builds
        run: |
          if (Test-Path build) { Remove-Item -Recurse -Force build }
          if (Test-Path dist) { Remove-Item -Recurse -Force dist }

      - name: Build with PyInstaller (onedir) from main.py
        run: |
          # ensure explicit dist output folder to produce a proper onedir layout
          pyinstaller --clean --noconfirm --log-level=DEBUG --onedir --windowed --distpath "dist/PropertyManager" main.py
          # copy runtime data files (DB, icons, logos) into the onedir so users who download the zip get a runnable package
          if (Test-Path 'property.db') { Copy-Item -Path 'property.db' -Destination 'dist/PropertyManager' -Force }
          Get-ChildItem -Path . -Include 'logo.*','*.ico','*.jpg' -File -ErrorAction SilentlyContinue | ForEach-Object { Copy-Item -Path $_.FullName -Destination 'dist/PropertyManager' -Force }

      - name: List build output
        run: |
          if (Test-Path -Path "dist") {
            Get-ChildItem -Path dist -Recurse -File | ForEach-Object { Write-Output $_.FullName }
          } else {
            Write-Output "dist not found"
          }

      - name: Archive onedir and upload artifact
        run: |
          if (Test-Path "dist/PropertyManager") {
            $zip = "dist/PropertyManager-Win7-OneDir.zip"
            if (Test-Path $zip) { Remove-Item $zip -Force }
            # Compress the entire folder so subdirectories are preserved
            Compress-Archive -Path "dist/PropertyManager" -DestinationPath $zip -Force
            Write-Output "Created zip: $zip"
          } else {
            Write-Output "dist/PropertyManager not found; listing dist:"
            dir dist -Recurse
            exit 1
          }
      - name: Upload onedir artifact
        uses: actions/upload-artifact@v4
        with:
          name: PropertyManager-Win7-OneDir
          path: dist/PropertyManager-Win7-OneDir.zip
          retention-days: 30

      - name: Build one-file EXE from spec (optional)
        run: |
          if (Test-Path "PropertyManager-win7.spec") {
            Write-Output "Building one-file EXE using spec (will use runtime_tmpdir from spec)"
            pyinstaller --clean --noconfirm --log-level=DEBUG PropertyManager-win7.spec --distpath "dist/PropertyManager-EXE"
            $zipExe = "dist/PropertyManager-Win7-EXE.zip"
            if (Test-Path $zipExe) { Remove-Item $zipExe -Force }
            Compress-Archive -Path "dist/PropertyManager-EXE" -DestinationPath $zipExe -Force
            Write-Output "Created one-file zip: $zipExe"
          } else {
            Write-Output "spec not found, skipping one-file build"
          }
        continue-on-error: true

      - name: Upload one-file artifact (if created)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: PropertyManager-Win7-EXE
          path: dist/PropertyManager-Win7-EXE.zip
          retention-days: 30

      - name: Build Windows installer with Inno Setup (optional)
        run: |
          # Install Inno Setup via Chocolatey (available on windows-latest runners)
          choco install innosetup -y
          # Prepare installer files directory and download VC++ redistributables (optional but recommended)
          New-Item -Path 'tools/installer/installer_files' -ItemType Directory -Force | Out-Null
          Invoke-WebRequest -Uri 'https://aka.ms/vs/17/release/vc_redist.x64.exe' -OutFile 'tools/installer/installer_files/vc_redist_x64.exe' -UseBasicParsing -ErrorAction SilentlyContinue
          Invoke-WebRequest -Uri 'https://aka.ms/vs/17/release/vc_redist.x86.exe' -OutFile 'tools/installer/installer_files/vc_redist_x86.exe' -UseBasicParsing -ErrorAction SilentlyContinue
          # Build installer (ISCC path installed by choco)
          & 'C:\Program Files (x86)\Inno Setup 6\ISCC.exe' 'tools\installer\PropertyManagerInstaller.iss'
          Write-Output "Installer build complete. Listing installer outputs:"
          Get-ChildItem -Path 'tools/installer' -Filter 'PropertyManager-Installer*.exe' -Recurse | ForEach-Object { Write-Output $_.FullName }
        continue-on-error: true

      - name: Upload installer artifact (if created)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: PropertyManager-Installer
          path: tools/installer/PropertyManager-Installer*.exe
          retention-days: 30

      - name: Upload build logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: build-logs
          path: build/

      - name: Generate sample receipt and runtime diag (CI)
        if: always()
        shell: pwsh
        run: |
          $script = @'
from datetime import datetime, timedelta
import os
try:
    # Minimal fake payment/resident/charge objects to render a sample receipt without DB
    class FakeResident:
        def __init__(self):
            self.name = "测试户"
            self.room_no = "1-1-101"
            self.full_room_no = self.room_no

    class FakeCharge:
        def __init__(self):
            self.id = 1
            self.name = "物业费"

    class FakePayment:
        def __init__(self):
            self.id = 1
            self.resident = FakeResident()
            self.charge_item = FakeCharge()
            self.charge_item_id = 1
            self.amount = 1616.00
            self.paid_amount = 1616.00
            self.billing_start_date = datetime(2025,11,16)
            self.billing_end_date = datetime(2026,11,15)
            self.billing_months = 12
            self.paid_months = 12
            self.created_at = datetime.now()

    os.makedirs('exports', exist_ok=True)
    from utils.printer import ReceiptPrinter
    rp = ReceiptPrinter(paper_size='收据纸 (241×93mm)', top_offset_mm=3.0, company_font_scale_adj=0.95, content_font_scale=1.0)
    p = FakePayment()
    # Render using PIL fallback to avoid requiring full Qt GUI in CI
    rp._render_receipt_to_image_pil(p, 'exports/receipt_ci_000001.png', dpi=180, payment_date_str=None, payment_seq=1)
    try:
        rp._write_runtime_diag(p, payment_id=p.id, image_size={'w':241,'h':93})
    except Exception:
        pass
    print('CI sample receipt generated')
except Exception as e:
    print('Failed to generate CI sample receipt:', e)
    raise
'@
          $tmp = Join-Path $env:RUNNER_TEMP 'ci_gen_receipt.py'
          Set-Content -Path $tmp -Value $script -Encoding UTF8
          python $tmp

      - name: Upload CI exports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ci-exports
          path: exports/
          retention-days: 7


name: Build Windows 7 Compatible EXE

on:
  workflow_dispatch:  # 手动触发
  push:
    branches:
      - main
      - master
    paths:
      - 'main.py'
      - 'requirements-win7.txt'
      - 'PropertyManager-win7.spec'
      - '.github/workflows/build-win7.yml'
  release:
    types: [created]

jobs:
  build:
    runs-on: windows-latest  # 使用 Windows Server 环境
    
    steps:
    - name: 检出代码
      uses: actions/checkout@v3
      
    - name: 设置 Python 3.8.10
      uses: actions/setup-python@v4
      with:
        python-version: '3.8.10'
        architecture: 'x64'
        
    - name: 显示 Python 版本
      run: python --version
      
    - name: 升级 pip
      run: python -m pip install --upgrade pip
      
    - name: 安装 Windows 7 兼容依赖
      run: |
        pip install -r requirements-win7.txt
        
    - name: 验证 PyInstaller 版本
      run: pyinstaller --version
      
    - name: 清理旧构建
      run: |
        if (Test-Path build) { Remove-Item -Recurse -Force build }
        if (Test-Path dist) { Remove-Item -Recurse -Force dist }
        
    - name: 打包应用程序
      run: |
        pyinstaller --clean PropertyManager-win7.spec
        
    - name: 检查打包结果
      run: |
        if (Test-Path "dist\PropertyManager.exe") {
          Write-Host "打包成功！"
          Get-Item "dist\PropertyManager.exe" | Select-Object Name, Length, LastWriteTime
        } else {
          Write-Host "打包失败：未找到 PropertyManager.exe"
          exit 1
        }
        
    - name: 重命名 exe 文件
      run: |
        if (Test-Path "dist\PropertyManager.exe") {
          Rename-Item -Path "dist\PropertyManager.exe" -NewName "物业收费管理系统_Win7.exe"
          Write-Host "文件已重命名为：物业收费管理系统_Win7.exe"
        }
        
    - name: 上传构建产物
      uses: actions/upload-artifact@v4
      with:
        name: PropertyManager-Win7-EXE
        path: dist/物业收费管理系统_Win7.exe
        retention-days: 30
        
    - name: 创建 Release 说明
      if: github.event_name == 'release'
      run: |
        $releaseNotes = @"
        ## Windows 7 兼容版本
        
        ### 系统要求
        - Windows 7 SP1 或更高版本
        - Visual C++ Redistributable 2015-2022
        
        ### 安装说明
        1. 下载 `物业收费管理系统_Win7.exe`
        2. 双击运行即可（首次运行可能需要较长时间解压）
        3. 程序会在同目录下创建 `property.db` 数据库文件
        
        ### 技术信息
        - Python 3.8.10
        - PyInstaller 4.10
        - PyQt5 5.15.10
        - SQLAlchemy 1.4.46
        
        ### 注意事项
        - 首次运行可能需要 10-30 秒解压
        - 如果遇到杀毒软件拦截，请添加信任
        - 建议将 exe 放在固定目录，避免移动后丢失数据库路径
        "@
        Set-Content -Path "RELEASE_NOTES.md" -Value $releaseNotes


name: Build Windows 7 Compatible EXE

on:
  workflow_dispatch:  # 手动触发
  push:
    branches:
      - main
      - master
    paths:
      - 'main.py'
      - 'requirements-win7.txt'
      - 'PropertyManager-win7.spec'
      - '.github/workflows/build-win7.yml'
  release:
    types: [created]

jobs:
  build:
    runs-on: windows-latest  # 使用 Windows Server 环境
    
    steps:
    - name: 检出代码
      uses: actions/checkout@v3
      
    - name: 设置 Python 3.8.10
      uses: actions/setup-python@v4
      with:
        python-version: '3.8.10'
        architecture: 'x64'
        
    - name: 显示 Python 版本
      run: python --version
      
    - name: 升级 pip
      run: python -m pip install --upgrade pip
      
    - name: 安装 Windows 7 兼容依赖
      run: |
        pip install -r requirements-win7.txt
        
    - name: 验证 PyInstaller 版本
      run: pyinstaller --version
      
    - name: 清理旧构建
      run: |
        if (Test-Path build) { Remove-Item -Recurse -Force build }
        if (Test-Path dist) { Remove-Item -Recurse -Force dist }
        
    - name: 打包应用程序
      run: |
        pyinstaller --clean PropertyManager-win7.spec
        
    - name: 检查 one-dir 产物（dist\\PropertyManager）
      run: |
        if (Test-Path "dist\PropertyManager") {
          Write-Host "one-dir 产物存在：dist\\PropertyManager"
          Get-ChildItem -Path "dist\PropertyManager" -Recurse | Select-Object FullName, Length
        } else {
          Write-Host "未找到 one-dir 产物 dist\\PropertyManager，尝试查找单个 exe..."
          if (Test-Path "dist\PropertyManager.exe") {
            Write-Host "找到单文件 exe：dist\\PropertyManager.exe"
            Get-Item "dist\PropertyManager.exe" | Select-Object Name, Length, LastWriteTime
          } else {
            Write-Host "打包失败：未找到 dist\\PropertyManager 或 dist\\PropertyManager.exe"
            exit 1
          }
        }

    - name: 压缩 one-dir 产物为 ZIP
      run: |
        if (Test-Path "dist\PropertyManager") {
          $zipPath = "dist\PropertyManager_win7.zip"
          if (Test-Path $zipPath) { Remove-Item $zipPath -Force }
          Compress-Archive -Path "dist\PropertyManager\*" -DestinationPath $zipPath -Force
          Write-Host "已创建压缩包: $zipPath"
        } elseif (Test-Path "dist\PropertyManager.exe") {
          $zipPath = "dist\PropertyManager_win7.zip"
          if (Test-Path $zipPath) { Remove-Item $zipPath -Force }
          Compress-Archive -Path "dist\PropertyManager.exe" -DestinationPath $zipPath -Force
          Write-Host "已创建压缩包（单文件 exe）: $zipPath"
        } else {
          Write-Host "没有可压缩的产物"; exit 1
        }

    - name: 上传 one-dir 构建产物 (ZIP)
      uses: actions/upload-artifact@v4
      with:
        name: PropertyManager-Win7-Artifact
        path: dist/PropertyManager_win7.zip
        retention-days: 30
        
    - name: 创建 Release 说明
      if: github.event_name == 'release'
      run: |
        $releaseNotes = @"
        ## Windows 7 兼容版本
        
        ### 系统要求
        - Windows 7 SP1 或更高版本
        - Visual C++ Redistributable 2015-2022
        
        ### 安装说明
        1. 下载 `物业收费管理系统_Win7.exe`
        2. 双击运行即可（首次运行可能需要较长时间解压）
        3. 程序会在同目录下创建 `property.db` 数据库文件
        
        ### 技术信息
        - Python 3.8.10
        - PyInstaller 4.10
        - PyQt5 5.15.10
        - SQLAlchemy 1.4.46
        
        ### 注意事项
        - 首次运行可能需要 10-30 秒解压
        - 如果遇到杀毒软件拦截，请添加信任
        - 建议将 exe 放在固定目录，避免移动后丢失数据库路径
        "@
        Set-Content -Path "RELEASE_NOTES.md" -Value $releaseNotes

